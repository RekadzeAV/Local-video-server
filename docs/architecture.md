# Architecture: Local-video-server

## Технологический стек

### Основной язык
- **Go (Golang) 1.21+**
  - Компилируемый язык с высокой производительностью
  - Кроссплатформенность (Windows, Linux, macOS, ARM, x86_64)
  - Встроенная поддержка конкурентности (goroutines)
  - Отличная стандартная библиотека для работы с сетью
  - Один исполняемый файл без зависимостей

### Внешние зависимости

#### Сетевое сканирование и протоколы
- **github.com/google/gopacket** — анализ сетевых пакетов, ARP сканирование
- **github.com/use-go/onvif** — поддержка ONVIF протокола и WS-Discovery

#### HTTP клиенты
- **github.com/go-resty/resty/v2** — HTTP клиент для проверки веб-интерфейсов камер

#### Конфигурация
- **gopkg.in/yaml.v3** — парсинг YAML конфигурационных файлов
- **github.com/spf13/viper** — универсальная система конфигурации
- **github.com/spf13/cobra** — CLI фреймворк для командной строки

#### Логирование
- **github.com/sirupsen/logrus** — структурированное логирование

### Внешние инструменты

#### FFmpeg (CLI)
- Проверка доступности RTSP потоков
- Получение детальной информации о потоках через `ffprobe`
- Fallback механизм для сложных случаев

## Архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                    Local-video-server                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────┐ │
│  │   Network    │    │   Protocol   │    │   RTSP   │ │
│  │   Scanner    │───▶│  Detector    │───▶│  Checker  │ │
│  └──────────────┘    └──────────────┘    └──────────┘ │
│         │                   │                   │       │
│         ▼                   ▼                   ▼       │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Device Discovery & Registry              │  │
│  └──────────────────────────────────────────────────┘  │
│         │                                               │
│         ▼                                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Results Storage & Export                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## Структура проекта

```
Local-video-server/
├── cmd/
│   └── server/
│       └── main.go                 # Точка входа приложения
│
├── internal/                       # Внутренние пакеты (не экспортируются)
│   ├── scanner/                    # Модуль сканирования сети
│   │   ├── network.go             # Сканирование сети (ARP, порты)
│   │   ├── onvif.go               # ONVIF Discovery
│   │   ├── upnp.go                # UPnP/SSDP Discovery
│   │   └── detector.go            # Определение протоколов
│   │
│   ├── rtsp/                       # Модуль работы с RTSP
│   │   ├── checker.go             # Проверка RTSP каналов
│   │   ├── parser.go              # Парсинг RTSP ответов
│   │   └── ffmpeg.go              # Интеграция с FFmpeg
│   │
│   ├── protocols/                  # Детекторы протоколов
│   │   ├── rtsp.go                # RTSP детектор
│   │   ├── rtmp.go                # RTMP детектор
│   │   ├── hls.go                 # HLS детектор
│   │   ├── webrtc.go              # WebRTC детектор
│   │   ├── mjpeg.go               # MJPEG детектор
│   │   └── dash.go                # MPEG-DASH детектор
│   │
│   ├── models/                     # Модели данных
│   │   ├── device.go              # Модель устройства
│   │   ├── stream.go              # Модель потока
│   │   └── config.go              # Конфигурация
│   │
│   ├── storage/                     # Хранение данных
│   │   └── registry.go            # Реестр устройств
│   │
│   └── export/                      # Экспорт результатов
│       ├── json.go                 # Экспорт в JSON
│       ├── csv.go                  # Экспорт в CSV
│       └── xml.go                  # Экспорт в XML
│
├── pkg/                            # Публичные пакеты (могут использоваться внешне)
│   └── utils/
│       ├── network.go              # Утилиты для работы с сетью
│       └── logger.go               # Логирование
│
├── configs/                        # Конфигурационные файлы
│   └── config.yaml                 # Основной конфигурационный файл
│
├── docs/                           # Документация
│   ├── project.md
│   ├── architecture.md
│   ├── patterns.md
│   ├── features.md
│   ├── database.md
│   ├── deployment.md
│   ├── business-rules.md
│   ├── ux-guidelines.md
│   ├── git-workflow.md
│   ├── monitoring.md
│   └── roadmap.md
│
├── go.mod                          # Go модули
├── go.sum                          # Зависимости
├── Makefile                        # Сборка и задачи
├── README.md                       # Основная документация
├── ANALYSIS.md                     # Анализ технологий
└── DEVELOPMENT_PLAN.md             # План разработки
```

## Компоненты системы

### 1. Network Scanner (`internal/scanner/`)
**Ответственность:** Обнаружение устройств в локальной сети

**Методы обнаружения:**
- ARP сканирование — получение списка активных хостов
- Порт сканирование — проверка стандартных портов (554 RTSP, 1935 RTMP, 80/8080 HTTP)
- ONVIF Discovery — WS-Discovery протокол для стандартизированных камер
- UPnP/SSDP Discovery — обнаружение устройств через UPnP

**Особенности:**
- Параллельное сканирование с использованием goroutines
- Настраиваемые таймауты
- Обработка ошибок сети

### 2. Protocol Detector (`internal/protocols/`)
**Ответственность:** Определение поддерживаемых протоколов на устройствах

**Поддерживаемые протоколы:**
- RTSP — подключение к порту 554, отправка OPTIONS/DESCRIBE
- RTMP — подключение к порту 1935, handshake
- HLS — поиск .m3u8 манифестов через HTTP
- WebRTC — поиск WebRTC endpoints, проверка STUN/TURN
- MJPEG — определение MJPEG потоков через HTTP
- MPEG-DASH — поиск .mpd манифестов

**Особенности:**
- Модульная архитектура — каждый протокол в отдельном модуле
- Расширяемость — легко добавлять новые протоколы
- Кэширование результатов

### 3. RTSP Checker (`internal/rtsp/`)
**Ответственность:** Проверка RTSP каналов и получение параметров

**Функции:**
- Реализация RTSP клиента (OPTIONS, DESCRIBE, SETUP, PLAY)
- Парсинг SDP (Session Description Protocol)
- Извлечение параметров потока (кодеки, разрешение, FPS, битрейт)
- Поддержка аутентификации (Basic, Digest)
- Интеграция с FFmpeg для детального анализа

**Особенности:**
- Fallback на FFmpeg при проблемах с парсингом
- Поддержка многоканальных камер
- Обработка различных форматов SDP

### 4. Device Registry (`internal/storage/`)
**Ответственность:** Хранение информации об обнаруженных устройствах

**Функции:**
- Структурированное хранение данных об устройствах
- Кэширование результатов сканирования
- Обновление информации об устройствах
- Управление состоянием устройств

### 5. Results Export (`internal/export/`)
**Ответственность:** Экспорт результатов в различные форматы

**Форматы:**
- JSON — структурированный формат для интеграций
- CSV — табличный формат для анализа
- XML — формат для интеграций с другими системами
- YAML — читаемый формат для конфигураций

## Ключевые зависимости

### go.mod
```go
module github.com/yourusername/local-video-server

go 1.21

require (
    // ONVIF
    github.com/use-go/onvif v0.0.0-20231025082739-ff6e66b2e8f5
    
    // Сетевое сканирование
    github.com/google/gopacket v1.1.19
    
    // HTTP клиент
    github.com/go-resty/resty/v2 v2.11.0
    
    // Конфигурация
    gopkg.in/yaml.v3 v3.0.1
    github.com/spf13/viper v1.18.2
    
    // CLI
    github.com/spf13/cobra v1.8.0
    
    // Логирование
    github.com/sirupsen/logrus v1.9.3
)
```

## Внешние интеграции

### FFmpeg
- **Назначение:** Проверка RTSP потоков и получение детальной информации
- **Использование:** CLI вызовы `ffprobe` для анализа потоков
- **Требования:** FFmpeg должен быть установлен в системе и доступен в PATH
- **Fallback:** Используется когда встроенный RTSP клиент не может получить информацию

### Системные вызовы
- **ARP таблица** — получение списка активных устройств в сети
- **DNS резолвинг** — определение hostname устройств
- **Сетевые интерфейсы** — автоматическое определение подсети для сканирования

## Принципы архитектуры

1. **Модульность** — каждый компонент отвечает за свою область
2. **Расширяемость** — легко добавлять новые протоколы и методы обнаружения
3. **Производительность** — параллельное выполнение операций через goroutines
4. **Надежность** — обработка ошибок, retry механизмы, graceful degradation
5. **Простота** — минимальные зависимости, понятная структура кода

## Потоки данных

### Процесс сканирования:
1. **Инициализация** — загрузка конфигурации, определение сетевых интерфейсов
2. **Обнаружение устройств** — Network Scanner находит активные хосты
3. **Определение протоколов** — Protocol Detector проверяет каждый протокол
4. **Анализ RTSP** — RTSP Checker получает детальную информацию о потоках
5. **Сохранение** — Device Registry сохраняет результаты
6. **Экспорт** — Results Export формирует выходные файлы

### Параллелизм:
- Сканирование устройств выполняется параллельно (goroutines)
- Каждое устройство обрабатывается независимо
- Результаты собираются через каналы (channels)
- Синхронизация через sync.WaitGroup

## Производительность

### Оптимизации:
- Параллельное сканирование устройств
- Настраиваемые таймауты для каждого типа запроса
- Кэширование DNS запросов
- Управление пулом соединений
- Ограничение количества одновременных соединений

### Ожидаемые показатели:
- Сканирование сети /24 (254 хоста): до 5 минут
- Параллельная обработка: до 50 устройств одновременно
- Потребление памяти: < 100 MB для типичной сети



