# Business Rules: Бизнес-логика проекта

## Общие принципы работы

### 1. Приоритет методов обнаружения

При сканировании сети используются несколько методов обнаружения устройств. Порядок применения и приоритет:

1. **ONVIF WS-Discovery** (высший приоритет)
   - Если устройство отвечает на ONVIF Probe, оно считается видеокамерой
   - ONVIF устройства получают полную информацию через ONVIF API
   - Время ожидания ответа: 10 секунд

2. **UPnP/SSDP Discovery**
   - Используется для обнаружения устройств с поддержкой UPnP
   - Время ожидания ответа: 5 секунд

3. **ARP сканирование + сканирование портов**
   - Базовый метод для всех устройств в сети
   - Проверяются стандартные порты: 554 (RTSP), 1935 (RTMP), 80, 8080 (HTTP)
   - Время ожидания на порт: 5 секунд

**Правило:** Если устройство обнаружено несколькими методами, информация объединяется, приоритет отдается более детальной информации.

---

## 2. Определение видеокамеры

### Критерии для классификации устройства как видеокамеры:

1. **Обязательные критерии (хотя бы один):**
   - Устройство отвечает на ONVIF Probe
   - Устройство имеет открытый порт 554 (RTSP)
   - Устройство имеет открытый порт 1935 (RTMP)
   - Устройство отвечает на UPnP M-SEARCH с типом "NetworkCamera"

2. **Дополнительные критерии (подтверждающие):**
   - HTTP ответ содержит заголовки, указывающие на производителя камеры (Hikvision, Dahua, Axis, etc.)
   - Обнаружен MJPEG поток через HTTP
   - Обнаружен HLS манифест (.m3u8)

**Правило:** Если устройство соответствует хотя бы одному обязательному критерию, оно считается видеокамерой и включается в результаты.

---

## 3. Обработка RTSP потоков

### Логика проверки RTSP каналов:

1. **Определение базового URL:**
   - Если устройство обнаружено через ONVIF, используются URL из ONVIF API
   - Если нет, используются стандартные шаблоны:
     - `rtsp://{ip}:554/Streaming/Channels/101` (Hikvision)
     - `rtsp://{ip}:554/cam/realmonitor?channel=1&subtype=0` (Dahua)
     - `rtsp://{ip}:554/stream1` (общий)
     - `rtsp://{ip}:554/live` (общий)

2. **Проверка доступности:**
   - Отправка RTSP OPTIONS запроса
   - Если требуется аутентификация, попытка подключения с учетными данными из конфигурации
   - Время ожидания: 10 секунд

3. **Получение параметров:**
   - Отправка RTSP DESCRIBE запроса
   - Парсинг SDP (Session Description Protocol)
   - Если парсинг не удался, используется FFmpeg (`ffprobe`) как fallback

4. **Многоканальные камеры:**
   - Если обнаружено несколько каналов, каждый проверяется отдельно
   - Каналы нумеруются начиная с 1
   - Максимальное количество каналов для проверки: 8 (настраивается)

**Правило:** Если RTSP поток недоступен, но устройство определено как камера, оно все равно включается в результаты с пометкой "RTSP недоступен".

---

## 4. Определение протоколов

### Порядок проверки протоколов:

1. **RTSP** (порт 554)
   - Проверяется первым, так как наиболее распространен
   - Метод: подключение и отправка OPTIONS

2. **ONVIF** (порт 80, 8080)
   - Проверяется через WS-Discovery и HTTP запросы к `/onvif/device_service`

3. **RTMP** (порт 1935)
   - Проверка handshake соединения

4. **HTTP протоколы** (порт 80, 8080)
   - HLS: поиск `.m3u8` файлов
   - MJPEG: проверка HTTP endpoints с `Content-Type: multipart/x-mixed-replace`
   - MPEG-DASH: поиск `.mpd` файлов

5. **WebRTC**
   - Поиск WebRTC endpoints в веб-интерфейсе
   - Проверка STUN/TURN серверов

**Правило:** Протокол считается поддерживаемым, если устройство отвечает на соответствующие запросы в течение таймаута.

---

## 5. Обработка ошибок и таймаутов

### Стратегия обработки ошибок:

1. **Сетевые ошибки:**
   - `Connection refused` → устройство не доступно, пропускается
   - `Connection timeout` → устройство не отвечает, пропускается
   - `Network unreachable` → ошибка сети, логируется, сканирование продолжается

2. **Таймауты:**
   - Каждая операция имеет свой таймаут (настраивается в конфигурации)
   - По умолчанию:
     - Сканирование порта: 5 секунд
     - RTSP проверка: 10 секунд
     - ONVIF запрос: 10 секунд
     - HTTP запрос: 5 секунд

3. **Retry механизм:**
   - Количество попыток: 2 (настраивается)
   - Задержка между попытками: 1 секунда
   - Экспоненциальная задержка: опционально

**Правило:** Ошибки отдельных устройств не должны останавливать сканирование всей сети. Все ошибки логируются с уровнем WARN или ERROR.

---

## 6. Кэширование и обновление данных

### Логика работы с кэшем:

1. **Временное хранение:**
   - Результаты сканирования хранятся в памяти во время работы приложения
   - После завершения сканирования данные экспортируются в файлы

2. **Обновление информации:**
   - Если устройство уже было обнаружено ранее, информация обновляется
   - Приоритет отдается более свежей информации
   - Время обнаружения (`DiscoveredAt`) обновляется при каждом новом сканировании

3. **Дубликаты:**
   - Устройства идентифицируются по IP-адресу
   - Если одно устройство обнаружено несколькими методами, информация объединяется

**Правило:** IP-адрес является уникальным идентификатором устройства. MAC-адрес и hostname могут отсутствовать или изменяться.

---

## 7. Экспорт результатов

### Правила экспорта:

1. **Формат по умолчанию:**
   - Если формат не указан, используется JSON
   - JSON обеспечивает структурированность и читаемость

2. **Структура данных:**
   - Все устройства экспортируются в массиве
   - Каждое устройство содержит полную информацию о протоколах и потоках
   - Пустые поля могут быть опущены (опционально)

3. **Именование файлов:**
   - Если имя файла не указано, используется: `scan_results_{timestamp}.{format}`
   - Формат timestamp: `YYYY-MM-DD_HH-MM-SS`
   - Файлы сохраняются в директорию, указанную в конфигурации (`export.output_dir`)

**Правило:** Экспорт должен быть идемпотентным — повторный экспорт с теми же параметрами должен давать идентичный результат (кроме временных меток).

---

## 8. Параллельное сканирование

### Ограничения и управление:

1. **Максимальное количество одновременных соединений:**
   - По умолчанию: 50 (настраивается в `scanner.max_concurrent`)
   - Ограничение предотвращает перегрузку сети и системы

2. **Worker pool:**
   - Используется пул воркеров для управления параллельными операциями
   - Каждый воркер обрабатывает одно устройство за раз

3. **Приоритизация:**
   - ONVIF и UPnP discovery выполняются параллельно со сканированием портов
   - RTSP проверка выполняется после обнаружения устройства

**Правило:** Количество параллельных операций не должно превышать `max_concurrent`, чтобы не перегружать сеть и не блокировать другие устройства.

---

## 9. Определение производителя и модели

### Источники информации:

1. **ONVIF API:**
   - `GetDeviceInformation` → Manufacturer, Model
   - Наиболее надежный источник

2. **HTTP заголовки:**
   - `Server` заголовок часто содержит информацию о производителе
   - Примеры: "Hikvision-Webs", "Dahua-Webs", "Axis"

3. **MAC-адрес (OUI):**
   - Первые 3 байта MAC-адреса (OUI) могут указывать на производителя
   - Используется как дополнительный источник

4. **RTSP ответы:**
   - Некоторые камеры указывают производителя в RTSP ответах

**Правило:** Приоритет источников: ONVIF API > HTTP заголовки > MAC OUI > RTSP ответы. Если информация из разных источников конфликтует, используется более надежный источник.

---

## 10. Безопасность и аутентификация

### Обработка учетных данных:

1. **Хранение учетных данных:**
   - Учетные данные хранятся в конфигурационном файле (опционально)
   - Рекомендуется использовать переменные окружения для production

2. **Типы аутентификации:**
   - **Basic:** используется для RTSP и HTTP
   - **Digest:** используется для RTSP (более безопасный)
   - **ONVIF:** использует WS-Security с username/password

3. **Попытки подключения:**
   - Если учетные данные не указаны, попытка подключения без аутентификации
   - Если указаны, используется указанная аутентификация
   - При ошибке 401/403, устройство помечается как "требует аутентификации"

**Правило:** Учетные данные никогда не логируются и не выводятся в консоль. При ошибках аутентификации выводится только факт ошибки, без деталей.

---

## 11. Валидация данных

### Проверка корректности данных:

1. **IP-адреса:**
   - Должны быть валидными IPv4 адресами
   - Поддержка IPv6: опционально (будущее)

2. **Порты:**
   - Должны быть в диапазоне 1-65535
   - Стандартные порты проверяются первыми

3. **URL:**
   - RTSP URL должны начинаться с `rtsp://`
   - HTTP URL должны начинаться с `http://` или `https://`

4. **Параметры потоков:**
   - Разрешение должно быть положительным числом
   - FPS должен быть в разумном диапазоне (1-120)
   - Битрейт должен быть положительным числом

**Правило:** Некорректные данные не должны приводить к падению приложения. Ошибки валидации логируются, некорректные записи пропускаются или помечаются как "невалидные".

---

## 12. Логирование и мониторинг

### Уровни логирования:

1. **DEBUG:**
   - Детальная информация о каждом шаге сканирования
   - Используется для отладки

2. **INFO:**
   - Общая информация о процессе сканирования
   - Обнаруженные устройства, завершенные операции

3. **WARN:**
   - Предупреждения о проблемах, которые не останавливают работу
   - Таймауты, недоступные устройства

4. **ERROR:**
   - Критические ошибки, которые могут повлиять на результаты
   - Ошибки сети, ошибки парсинга

**Правило:** В production используется уровень INFO. DEBUG используется только для диагностики проблем.

---

## 13. Конфигурация по умолчанию

### Значения по умолчанию:

Если конфигурационный файл не указан или параметры отсутствуют, используются следующие значения:

```yaml
scanner:
  subnet: "auto"              # Автоматическое определение
  timeout: 5s                 # Таймаут для сканирования портов
  max_concurrent: 50          # Максимум параллельных операций
  ports: [554, 1935, 80, 8080] # Стандартные порты

protocols:
  rtsp:
    enabled: true
    timeout: 10s
  onvif:
    enabled: true
    timeout: 10s

rtsp:
  check_streams: true
  use_ffmpeg: true

export:
  default_format: "json"
  output_dir: "./exports"

logging:
  level: "info"
  format: "json"
  output: "stdout"
```

**Правило:** Все параметры должны иметь разумные значения по умолчанию, чтобы приложение работало "из коробки" без конфигурации.

---

## 14. Обработка больших сетей

### Оптимизация для больших подсетей:

1. **Разбиение на батчи:**
   - Большие подсети (например, /16) разбиваются на более мелкие батчи
   - Размер батча: /24 (256 адресов)

2. **Прогресс-индикация:**
   - Вывод прогресса сканирования для больших сетей
   - Формат: "Сканирование: 150/256 (58%)"

3. **Раннее завершение:**
   - Опционально: возможность прервать сканирование (Ctrl+C)
   - Graceful shutdown: завершение текущих операций перед выходом

**Правило:** Сканирование больших сетей не должно блокировать систему. Используется ограничение параллельных операций и батчинг.

---

## 15. Совместимость и расширяемость

### Принципы расширения:

1. **Добавление новых протоколов:**
   - Новые протоколы добавляются через интерфейс `ProtocolDetector`
   - Каждый протокол — отдельный модуль

2. **Добавление новых методов обнаружения:**
   - Новые методы discovery добавляются через интерфейс `DeviceDiscoverer`
   - Все методы работают параллельно

3. **Обратная совместимость:**
   - Изменения в структурах данных должны быть обратно совместимы
   - Старые форматы экспорта должны поддерживаться

**Правило:** Архитектура должна позволять легко добавлять новые протоколы и методы обнаружения без изменения существующего кода.

