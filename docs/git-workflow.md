# Git Workflow: Правила работы с Git и GitHub

## Общие принципы

### 1. Структура репозитория

- **Основная ветка:** `main` — стабильная версия, всегда готова к развертыванию
- **Ветка разработки:** `develop` — текущая разработка (опционально)
- **Ветки функций:** `feature/название-функции` — разработка новых функций
- **Ветки исправлений:** `fix/описание-бага` — исправление багов
- **Ветки релизов:** `release/версия` — подготовка релиза (опционально)

### 2. Коммиты

#### Формат сообщений коммитов:

```
<тип>: <краткое описание>

<подробное описание (опционально)>

<ссылки на issues (опционально)>
```

#### Типы коммитов:
- `feat:` — новая функция
- `fix:` — исправление бага
- `docs:` — изменения в документации
- `style:` — форматирование, отсутствующие точки с запятой и т.д.
- `refactor:` — рефакторинг кода
- `test:` — добавление или исправление тестов
- `chore:` — обновление задач сборки, настройки и т.д.
- `perf:` — улучшение производительности
- `ci:` — изменения в CI/CD конфигурации

#### Примеры:
```
feat: добавлено сканирование ONVIF устройств

Реализован WS-Discovery протокол для обнаружения ONVIF камер.
Добавлена поддержка получения информации об устройствах через ONVIF API.

Closes #12
```

```
fix: исправлена обработка таймаутов при сканировании портов

Таймауты теперь корректно обрабатываются для всех типов сетевых операций.
Добавлен retry механизм с экспоненциальной задержкой.

Fixes #8
```

```
docs: обновлена документация по развертыванию

Добавлены инструкции по развертыванию на Windows через NSSM.
Обновлены примеры конфигурационных файлов.
```

---

## Рабочий процесс (Workflow)

### 1. Начало работы над задачей

#### Шаг 1: Обновление основной ветки
```bash
git checkout main
git pull origin main
```

#### Шаг 2: Создание ветки для функции/исправления
```bash
# Для новой функции
git checkout -b feature/onvif-discovery

# Для исправления бага
git checkout -b fix/rtsp-timeout-handling
```

#### Шаг 3: Работа над задачей
- Делайте частые коммиты с понятными сообщениями
- Коммитьте логически связанные изменения вместе

### 2. Коммиты во время разработки

#### Правила:
- Коммитьте часто, но логически связанные изменения вместе
- Каждый коммит должен быть работоспособным (проект компилируется)
- Избегайте коммитов с сообщениями типа "WIP" или "fix"

#### Пример хорошей последовательности коммитов:
```
feat: добавлена структура Device и Protocol

feat: реализовано базовое сканирование сети

feat: добавлена поддержка параллельного сканирования

test: добавлены тесты для сетевого сканера

docs: обновлена документация по архитектуре
```

### 3. Завершение работы над задачей

#### Шаг 1: Проверка изменений
```bash
# Просмотр изменений
git status
git diff

# Проверка, что все компилируется
go build ./...

# Запуск тестов
go test ./...
```

#### Шаг 2: Обновление ветки main (если нужно)
```bash
git checkout main
git pull origin main
git checkout feature/your-feature
git rebase main  # или git merge main
```

#### Шаг 3: Push ветки в удаленный репозиторий
```bash
git push origin feature/your-feature
```

#### Шаг 4: Создание Pull Request
- Создайте Pull Request на GitHub
- Укажите описание изменений
- Свяжите с соответствующими issues (если есть)
- Попросите code review (если требуется)

---

## Pull Request (PR)

### 1. Название PR

#### Формат:
```
<тип>: <краткое описание>
```

#### Примеры:
```
feat: Добавлено сканирование ONVIF устройств
fix: Исправлена обработка таймаутов при сканировании
docs: Обновлена документация по развертыванию
```

### 2. Описание PR

#### Шаблон:
```markdown
## Описание
Краткое описание изменений

## Тип изменений
- [ ] Новая функция
- [ ] Исправление бага
- [ ] Обновление документации
- [ ] Рефакторинг
- [ ] Улучшение производительности

## Изменения
- Что было изменено
- Какие функции добавлены
- Какие баги исправлены

## Тестирование
- Как тестировалось
- Какие тесты добавлены/обновлены

## Чеклист
- [ ] Код следует стилю проекта
- [ ] Добавлены/обновлены тесты
- [ ] Обновлена документация
- [ ] Все тесты проходят
- [ ] Код проверен на наличие багов
```

### 3. Code Review

#### Для ревьюеров:
- Проверяйте код на соответствие стандартам проекта
- Обращайте внимание на потенциальные баги
- Проверяйте тесты и покрытие
- Убедитесь, что документация обновлена

#### Для авторов:
- Отвечайте на комментарии ревьюеров
- Вносите изменения в том же PR (не создавайте новый)
- Отмечайте комментарии как resolved после исправления

---

## Ветвление (Branching)

### 1. Названия веток

#### Формат:
```
<тип>/<краткое-описание>
```

#### Типы веток:
- `feature/` — новые функции
- `fix/` — исправления багов
- `docs/` — изменения в документации
- `refactor/` — рефакторинг
- `test/` — добавление тестов
- `chore/` — обновление зависимостей, конфигурации

#### Примеры:
```
feature/onvif-discovery
feature/rtsp-stream-analysis
fix/network-scanning-timeout
fix/ffmpeg-integration-error
docs/deployment-instructions
refactor/device-registry
test/network-scanner-tests
```

### 2. Управление ветками

#### Удаление локальных веток:
```bash
# После мерджа в main
git branch -d feature/onvif-discovery
```

#### Удаление удаленных веток:
```bash
# После мерджа PR
git push origin --delete feature/onvif-discovery
```

#### Очистка удаленных веток:
```bash
# Удалить ссылки на удаленные ветки
git fetch --prune
```

---

## Теги и релизы

### 1. Версионирование

#### Формат версий (Semantic Versioning):
```
MAJOR.MINOR.PATCH
```

- **MAJOR** — несовместимые изменения API
- **MINOR** — новая функциональность с обратной совместимостью
- **PATCH** — исправления багов с обратной совместимостью

#### Примеры:
```
v1.0.0  # Первый стабильный релиз
v1.1.0  # Добавлена новая функция
v1.1.1  # Исправлен баг
v2.0.0  # Крупные изменения, несовместимые с v1.x
```

### 2. Создание тегов

#### Создание тега:
```bash
# Аннотированный тег (рекомендуется)
git tag -a v1.0.0 -m "Релиз версии 1.0.0"

# Push тега в удаленный репозиторий
git push origin v1.0.0
```

#### Список тегов:
```bash
git tag
git tag -l "v1.*"
```

#### Удаление тега:
```bash
# Локально
git tag -d v1.0.0

# Удаленно
git push origin --delete v1.0.0
```

### 3. Релизы

#### Процесс создания релиза:
1. Обновить версию в коде (если используется)
2. Обновить CHANGELOG.md
3. Создать тег
4. Push тега в GitHub
5. Создать Release на GitHub с описанием изменений

---

## Работа с Issues

### 1. Создание Issues

#### Типы Issues:
- **Bug** — сообщение об ошибке
- **Feature** — предложение новой функции
- **Enhancement** — улучшение существующей функции
- **Documentation** — улучшение документации
- **Question** — вопрос о проекте

#### Шаблон для Bug:
```markdown
## Описание бага
Краткое описание проблемы

## Шаги для воспроизведения
1. Шаг 1
2. Шаг 2
3. Шаг 3

## Ожидаемое поведение
Что должно происходить

## Фактическое поведение
Что происходит на самом деле

## Окружение
- ОС: [например, Windows 10]
- Версия: [например, v1.0.0]
- Конфигурация: [если применимо]

## Дополнительная информация
Логи, скриншоты и т.д.
```

#### Шаблон для Feature:
```markdown
## Описание функции
Что должна делать новая функция

## Обоснование
Почему эта функция нужна

## Предлагаемая реализация
Как можно это реализовать (если есть идеи)

## Альтернативы
Другие варианты решения (если есть)
```

### 2. Закрытие Issues

#### Связывание коммитов с Issues:
```bash
# В сообщении коммита
git commit -m "fix: исправлена обработка таймаутов

Fixes #8"
```

#### Ключевые слова для закрытия:
- `Closes #123` — закрывает issue
- `Fixes #123` — исправляет баг и закрывает issue
- `Resolves #123` — решает проблему и закрывает issue

---

## .gitignore

### Стандартный .gitignore для Go проекта:

```gitignore
# Binaries
*.exe
*.exe~
*.dll
*.so
*.dylib
local-video-server
local-video-server.exe

# Test binary
*.test

# Output of the go coverage tool
*.out

# Dependency directories
vendor/

# Go workspace file
go.work

# IDE
.idea/
.vscode/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Project specific
configs/config.local.yaml
exports/
logs/
*.log

# Temporary files
tmp/
temp/
```

---

## Конфликты и их разрешение

### 1. Предотвращение конфликтов

- Регулярно обновляйте свою ветку из main:
```bash
git checkout main
git pull origin main
git checkout your-branch
git rebase main  # или git merge main
```

### 2. Разрешение конфликтов

#### При rebase:
```bash
# Если возникли конфликты
git rebase --continue  # после разрешения
git rebase --abort     # отменить rebase
```

#### При merge:
```bash
# Разрешить конфликты в файлах
# Затем:
git add .
git commit
```

---

## Best Practices

### 1. Частые коммиты

- Коммитьте часто, но логически связанные изменения вместе
- Каждый коммит должен быть работоспособным

### 2. Понятные сообщения

- Используйте понятные сообщения коммитов
- Избегайте сообщений типа "fix", "update", "changes"

### 3. Не коммитьте

- Секреты и пароли
- Временные файлы
- Локальные конфигурации
- Большие бинарные файлы

### 4. Тестирование перед коммитом

- Убедитесь, что код компилируется
- Запустите тесты
- Проверьте линтер (если настроен)

### 5. Регулярная синхронизация

- Регулярно обновляйте свою ветку из main
- Решайте конфликты как можно раньше

---

## Интеграция с GitHub

### 1. GitHub Actions (CI/CD)

#### Пример workflow для Go:
```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    - run: go test ./...
    - run: go build ./...
```

### 2. Защита веток

#### Настройки для main:
- Require pull request reviews
- Require status checks to pass
- Require branches to be up to date
- Do not allow force pushes
- Do not allow deletions

### 3. Templates

#### PR Template (`.github/pull_request_template.md`):
```markdown
## Описание
[Описание изменений]

## Тип изменений
- [ ] Новая функция
- [ ] Исправление бага
- [ ] Обновление документации

## Чеклист
- [ ] Код следует стилю проекта
- [ ] Добавлены тесты
- [ ] Все тесты проходят
- [ ] Обновлена документация
```

---

## Полезные команды

### Просмотр истории:
```bash
git log --oneline --graph --all
git log --author="Имя"
git log --since="2024-01-01"
```

### Поиск изменений:
```bash
git log -S "функция"  # поиск по содержимому
git log --grep="RTSP"  # поиск по сообщениям
```

### Отмена изменений:
```bash
git reset --soft HEAD~1    # отменить коммит, оставить изменения
git reset --hard HEAD~1    # отменить коммит и изменения
git checkout -- file.go    # отменить изменения в файле
```

### Статистика:
```bash
git shortlog -sn           # статистика по авторам
git diff --stat            # статистика изменений
```

---

## Резюме

### Основные правила:
1. ✅ Используйте понятные сообщения коммитов
2. ✅ Коммитьте часто, но логически связанные изменения вместе
3. ✅ Создавайте ветки для каждой задачи
4. ✅ Обновляйте ветку main перед созданием новой ветки
5. ✅ Тестируйте перед коммитом и push
6. ✅ Используйте Pull Requests для code review
7. ✅ Связывайте коммиты с Issues
8. ✅ Следуйте соглашениям о названиях веток и коммитов

### Чего избегать:
1. ❌ Коммиты с сообщениями "WIP", "fix", "update"
2. ❌ Коммиты секретов и паролей
3. ❌ Прямые коммиты в main (без PR)
4. ❌ Большие коммиты с несвязанными изменениями
5. ❌ Force push в общие ветки



