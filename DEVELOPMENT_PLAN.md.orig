<<<<<<< HEAD
# План разработки Local-video-server

## 1. Выбор технологического стека

### Основной язык: **Go (Golang)**

**Обоснование выбора:**
- ✅ **Быстродействие:** Компилируемый язык с производительностью близкой к C/C++
- ✅ **Универсальность:** Компилируется в один бинарный файл для любой ОС и архитектуры (Windows, Linux, macOS, ARM, x86_64)
- ✅ **Сетевые возможности:** Отличная стандартная библиотека для работы с сетью
- ✅ **Конкурентность:** Goroutines для параллельного сканирования сети
- ✅ **Низкое потребление памяти:** Эффективное управление ресурсами
- ✅ **Простота развертывания:** Один исполняемый файл без зависимостей

### Дополнительные инструменты:
- **FFmpeg** (CLI) - для проверки RTSP потоков и получения параметров
- **ONVIF библиотеки** - для обнаружения ONVIF устройств
- **gopacket** - для сетевого сканирования и анализа пакетов

---

## 2. Архитектура приложения

```
┌─────────────────────────────────────────────────────────┐
│                    Local-video-server                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────┐ │
│  │   Network    │    │   Protocol   │    │   RTSP   │ │
│  │   Scanner    │───▶│  Detector    │───▶│  Checker  │ │
│  ┌──────────────┘    ┌──────────────┘    ┌──────────┘ │
│         │                   │                   │       │
│         ▼                   ▼                   ▼       │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Device Discovery & Registry              │  │
│  └──────────────────────────────────────────────────┘  │
│         │                                               │
│         ▼                                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Results Storage & Export                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### Компоненты системы:

1. **Network Scanner** - Сканирование локальной сети
2. **Protocol Detector** - Определение протоколов на устройствах
3. **RTSP Checker** - Проверка RTSP каналов и получение параметров
4. **Device Registry** - Хранение информации об обнаруженных устройствах
5. **Results Export** - Экспорт результатов в различные форматы

---

## 3. Структура проекта

```
Local-video-server/
├── cmd/
│   └── server/
│       └── main.go                 # Точка входа приложения
├── internal/
│   ├── scanner/
│   │   ├── network.go            # Сканирование сети (ARP, порты)
│   │   ├── onvif.go              # ONVIF Discovery
│   │   ├── upnp.go               # UPnP/SSDP Discovery
│   │   └── detector.go           # Определение протоколов
│   ├── rtsp/
│   │   ├── checker.go            # Проверка RTSP каналов
│   │   ├── parser.go             # Парсинг RTSP ответов
│   │   └── ffmpeg.go             # Интеграция с FFmpeg
│   ├── protocols/
│   │   ├── rtsp.go               # RTSP клиент
│   │   ├── rtmp.go               # RTMP детектор
│   │   ├── hls.go                # HLS детектор
│   │   ├── webrtc.go             # WebRTC детектор
│   │   ├── mjpeg.go              # MJPEG детектор
│   │   └── dash.go               # MPEG-DASH детектор
│   ├── models/
│   │   ├── device.go             # Модель устройства
│   │   ├── stream.go             # Модель потока
│   │   └── config.go             # Конфигурация
│   ├── storage/
│   │   └── registry.go           # Хранение результатов
│   ├── export/
│   │   ├── json.go               # Экспорт в JSON
│   │   ├── csv.go                # Экспорт в CSV
│   │   └── xml.go                # Экспорт в XML
├── pkg/
│   └── utils/
│       ├── network.go             # Утилиты для работы с сетью
│       └── logger.go             # Логирование
├── configs/
│   └── config.yaml               # Конфигурационный файл
├── go.mod                        # Go модули
├── go.sum                        # Зависимости
├── Makefile                      # Сборка и задачи
├── README.md                     # Документация
└── DEVELOPMENT_PLAN.md           # Этот файл
```

---

## 4. Этапы разработки

### Этап 1: Базовая инфраструктура (Неделя 1)

#### 1.1. Инициализация проекта
- [ ] Создать Go модуль
- [ ] Настроить структуру проекта
- [ ] Добавить конфигурационную систему
- [ ] Настроить логирование
- [ ] Создать модели данных (Device, Stream, Config)

#### 1.2. Базовые утилиты
- [ ] Утилиты для работы с сетью (получение IP, маски подсети)
- [ ] Парсинг сетевых адресов

**Результат:** Рабочий каркас приложения с конфигурацией и логированием

---

### Этап 2: Сканирование сети (Неделя 2)

#### 2.1. Базовое сканирование сети
- [ ] Получение списка активных хостов через ARP
- [ ] Сканирование портов (554 RTSP, 1935 RTMP, 80/8080 HTTP)
- [ ] Параллельное сканирование с использованием goroutines
- [ ] Обработка таймаутов и ошибок

#### 2.2. ONVIF Discovery
- [ ] Реализация WS-Discovery протокола
- [ ] Отправка Probe сообщений
- [ ] Обработка ProbeMatch ответов
- [ ] Получение информации об устройствах через ONVIF API

#### 2.3. UPnP/SSDP Discovery
- [ ] Реализация SSDP протокола
- [ ] Отправка M-SEARCH запросов
- [ ] Обработка ответов от устройств
- [ ] Парсинг информации об устройствах

**Результат:** Обнаружение устройств в локальной сети различными методами

---

### Этап 3: Определение протоколов (Неделя 3)

#### 3.1. RTSP детектор
- [ ] Подключение к RTSP порту (554)
- [ ] Отправка OPTIONS/DESCRIBE запросов
- [ ] Парсинг ответов SDP
- [ ] Определение доступных потоков

#### 3.2. RTMP детектор
- [ ] Подключение к RTMP порту (1935)
- [ ] Отправка handshake запросов
- [ ] Определение доступности потока

#### 3.3. HTTP протоколы (HLS, MJPEG, MPEG-DASH)
- [ ] HTTP запросы к веб-интерфейсам камер
- [ ] Поиск HLS манифестов (.m3u8)
- [ ] Определение MJPEG потоков
- [ ] Поиск DASH манифестов (.mpd)

#### 3.4. WebRTC детектор
- [ ] Поиск WebRTC endpoints
- [ ] Проверка STUN/TURN серверов
- [ ] Определение WebRTC потоков

**Результат:** Определение всех поддерживаемых протоколов на каждом устройстве

---

### Этап 4: RTSP проверка и параметры (Неделя 4)

#### 4.1. RTSP клиент
- [ ] Реализация базового RTSP клиента
- [ ] Поддержка методов: OPTIONS, DESCRIBE, SETUP, PLAY
- [ ] Обработка аутентификации (Basic, Digest)
- [ ] Парсинг SDP (Session Description Protocol)

#### 4.2. Получение параметров потока
- [ ] Извлечение информации из SDP:
  - Видео кодеки (H.264, H.265, MJPEG)
  - Аудио кодеки (AAC, PCM, G.711)
  - Разрешение (width, height)
  - FPS (кадров в секунду)
  - Битрейт
  - Профили кодирования
- [ ] Получение информации о каналах (для многоканальных камер)

#### 4.3. Интеграция с FFmpeg
- [ ] Вызов FFmpeg для проверки доступности потока
- [ ] Получение детальной информации через `ffprobe`
- [ ] Парсинг вывода FFmpeg
- [ ] Fallback на FFmpeg если RTSP клиент не справляется

#### 4.4. Тестирование потоков
- [ ] Попытка подключения к потоку
- [ ] Проверка получения данных
- [ ] Определение работоспособности канала

**Результат:** Полная информация о RTSP каналах с параметрами настроек

---

### Этап 5: Хранение и экспорт (Неделя 5)

#### 5.1. Реестр устройств
- [ ] Структура для хранения обнаруженных устройств
- [ ] Кэширование результатов сканирования
- [ ] Обновление информации об устройствах
- [ ] Управление состоянием устройств

#### 5.2. Экспорт результатов
- [ ] Экспорт в JSON (структурированный формат)
- [ ] Экспорт в CSV (для таблиц)
- [ ] Экспорт в XML (для интеграций)
- [ ] Экспорт в YAML (читаемый формат)

#### 5.3. Форматирование вывода
- [ ] Красивый вывод в консоль
- [ ] Цветной вывод для терминала
- [ ] Табличное представление результатов
- [ ] Детальный вывод по запросу

**Результат:** Сохранение и экспорт результатов в различных форматах

---

### Этап 6: Оптимизация и доработка (Неделя 6)


**Выбранный фреймворк:** [Fyne](https://fyne.io/)

**Обоснование:**
- ✅ Кроссплатформенность (Windows, Linux, macOS)
- ✅ Современный дизайн, похожий на Material Design
- ✅ Возможность кастомизации под Windows 10/11 стиль
- ✅ Простота использования и хорошая документация
- ✅ Нативная производительность
- ✅ Поддержка темной и светлой темы
- ✅ Активное сообщество и развитие

  - Поле ввода подсети
  - Прогресс-бар с процентами
  - Статистика (найдено устройств, обработано, ошибок)
  - Таблица с колонками: IP, Производитель, Модель, Протоколы, Статус
  - Иконки статуса устройств
  - Иконки статуса (✓ доступно, ✗ недоступно, ⚠ предупреждение)
  - Информация об устройстве (IP, MAC, производитель, модель)
  - Вкладки: Общая информация, Протоколы, RTSP потоки
  - Кнопки действий: Экспорт, Копировать URL, Тест потока
  - Вкладки: Сеть, Сканирование, Экспорт, Интерфейс
  - Настройки темы оформления
  - Сохранение настроек
  - Сброс к значениям по умолчанию
#### 6.3. Дизайн в стиле Windows 10/11
- [ ] Цветовая схема Fluent Design:
  - Светлая тема (по умолчанию)
  - Темная тема (опционально)
  - Акцентные цвета Windows
  - Прозрачность и размытие (Acrylic эффект)
- [ ] Типографика:
  - Шрифт Segoe UI (системный шрифт Windows)
  - Правильные размеры шрифтов (12-14px для основного текста)
- **Темная тема (опционально):**
  - Фон: #202020 (темно-серый)
  - Фон панелей: #2D2D2D (темно-серый)
  - Текст: #FFFFFF (белый)
  - Акцент: #0078D4 (синий Windows)
  - Границы: #404040 (серая)

**Типографика:**
- Основной шрифт: Segoe UI (системный шрифт Windows)
- Размеры:
  - Заголовки: 20-24px
  - Подзаголовки: 16-18px
  - Основной текст: 12-14px
  - Мелкий текст: 10-11px
  - Иерархия заголовков
#### 6.4. Интеграция с backend
- [ ] Главное окно:
  - Заголовок с названием приложения
  - Меню (Файл, Сканирование, Настройки, Справка)
  - Панель инструментов с основными действиями
  - Область контента с вкладками
- [ ] Кнопки в стиле Windows 10/11
- [ ] Поля ввода с закругленными углами
- [ ] Карточки для устройств
- [ ] Иконки в стиле Fluent Icons
- [ ] Прозрачность и размытие (Acrylic эффект)

**Адаптивность:**
- [ ] Минимальный размер окна: 1024x768
- [ ] Оптимальный размер: 1280x720
- [ ] Поддержка изменения размера окна
- [ ] Адаптивная компоновка элементов

**Анимации и переходы:**
- [ ] Плавное появление элементов
- [ ] Анимация прогресс-бара
- [ ] Плавные переходы между вкладками
- [ ] Эффекты наведения на кнопки

#### 6.4. Функциональность GUI

**Основные функции:**
- [ ] Сканирование сети:
  - Выбор подсети для сканирования
  - Настройка параметров сканирования
  - Запуск/остановка сканирования
  - Отображение прогресса в реальном времени
  - Уведомления о найденных устройствах
- [ ] Просмотр результатов:
  - Список всех обнаруженных устройств
  - Фильтрация и поиск
  - Сортировка по различным параметрам
  - Детальная информация об устройстве
- [ ] Экспорт результатов:
  - Экспорт в JSON, CSV, XML, YAML
  - Выбор файла для сохранения
  - Уведомление об успешном экспорте
- [ ] Настройки:
  - Настройка параметров сети
  - Настройка сканирования
  - Выбор темы оформления
  - Настройки экспорта

#### 6.5. Интеграция с backend
#### 6.6. Структура GUI кода
```
internal/gui/
├── app.go              # Главное приложение и окно
├── scanner.go          # Компонент сканирования
├── devices.go          # Компонент списка устройств
├── details.go          # Компонент детальной информации
├── settings.go         # Компонент настроек
├── theme.go            # Тема оформления Windows 10/11
└── widgets/
    ├── device_card.go  # Виджет карточки устройства
    ├── progress.go     # Виджет прогресс-бара
    └── status_icon.go  # Виджет иконки статуса
```

- [ ] Оптимизация параллельного сканирования
- [ ] Настройка таймаутов
- [ ] Управление пулом соединений
- [ ] Кэширование DNS запросов

#### 6.2. Обработка ошибок
- [ ] Graceful handling ошибок сети
- [ ] Retry механизм для неудачных запросов
- [ ] Логирование ошибок
- [ ] Продолжение работы при ошибках отдельных устройств

#### 6.3. Конфигурация
- [ ] Настройка диапазонов сканирования
- [ ] Настройка таймаутов
- [ ] Настройка портов для сканирования
- [ ] Настройка методов обнаружения
- [ ] Валидация конфигурационных параметров
- [ ] Оптимизация загрузки и сохранения настроек

#### 6.4. Документация
- [ ] README с примерами использования
- [ ] Документация API (если будет)
- [ ] Примеры конфигураций
- [ ] Troubleshooting guide

**Результат:** Оптимизированное и стабильное приложение

---

## 5. Технические детали реализации

### 5.1. Сканирование сети

```go
// Псевдокод основной логики
func ScanNetwork(subnet string) []Device {
    devices := []Device{}
    
    // 1. Получить список активных хостов
    hosts := getActiveHosts(subnet)
    
    // 2. Параллельное сканирование
    var wg sync.WaitGroup
    results := make(chan Device, len(hosts))
    
    for _, host := range hosts {
        wg.Add(1)
        go func(ip string) {
            defer wg.Done()
            device := scanDevice(ip)
            if device != nil {
                results <- *device
            }
        }(host)
    }
    
    go func() {
        wg.Wait()
        close(results)
    }()
    
    for device := range results {
        devices = append(devices, device)
    }
    
    return devices
}
```

### 5.2. RTSP проверка

```go
// Псевдокод RTSP проверки
func CheckRTSPStream(url string) (*StreamInfo, error) {
    // 1. Подключение к RTSP серверу
    conn, err := net.Dial("tcp", extractHost(url))
    if err != nil {
        return nil, err
    }
    defer conn.Close()
    
    // 2. Отправка OPTIONS
    optionsReq := buildRTSPRequest("OPTIONS", url)
    conn.Write(optionsReq)
    
    // 3. Отправка DESCRIBE
    describeReq := buildRTSPRequest("DESCRIBE", url)
    conn.Write(describeReq)
    
    // 4. Парсинг SDP ответа
    response := readResponse(conn)
    sdp := parseSDP(response)
    
    // 5. Извлечение параметров
    streamInfo := extractStreamInfo(sdp)
    
    return streamInfo, nil
}
```

### 5.3. Модели данных

```go
// Device - обнаруженное устройство
type Device struct {
    IP          string            `json:"ip"`
    MAC         string            `json:"mac,omitempty"`
    Hostname    string            `json:"hostname,omitempty"`
    Manufacturer string           `json:"manufacturer,omitempty"`
    Model       string            `json:"model,omitempty"`
    Protocols   []Protocol        `json:"protocols"`
    RTSPStreams []RTSPStreamInfo  `json:"rtsp_streams,omitempty"`
    DiscoveredAt time.Time        `json:"discovered_at"`
}

// Protocol - поддерживаемый протокол
type Protocol struct {
    Type        string   `json:"type"` // RTSP, RTMP, HLS, etc.
    Port        int      `json:"port"`
    URL         string   `json:"url,omitempty"`
    Available   bool     `json:"available"`
}

// RTSPStreamInfo - информация о RTSP потоке
type RTSPStreamInfo struct {
    URL         string   `json:"url"`
    Codec       string   `json:"codec"`       // H.264, H.265, MJPEG
    Resolution  string   `json:"resolution"`  // 1920x1080
    FPS         float64  `json:"fps"`
    Bitrate     int      `json:"bitrate,omitempty"`
    AudioCodec  string   `json:"audio_codec,omitempty"`
    Channels    int      `json:"channels,omitempty"`
    Available   bool     `json:"available"`
}
```

---

## 6. Зависимости (go.mod)

```go
module github.com/yourusername/local-video-server

go 1.21

require (
    // ONVIF
    github.com/use-go/onvif v0.0.0-20231025082739-ff6e66b2e8f5
    
    // Сетевое сканирование
    github.com/google/gopacket v1.1.19
    
    // HTTP клиент
    github.com/go-resty/resty/v2 v2.11.0
    
    // Конфигурация
    gopkg.in/yaml.v3 v3.0.1
    
    // Логирование
    github.com/sirupsen/logrus v1.9.3
    
    // Утилиты
    github.com/spf13/cobra v1.8.0  // CLI
    github.com/spf13/viper v1.18.2 // Конфигурация
)
```

---

## 7. Пример использования

### Командная строка:

```bash
# Сканирование всей локальной сети
./local-video-server scan

# Сканирование конкретной подсети
./local-video-server scan --subnet 192.168.1.0/24

# Сканирование с проверкой RTSP
./local-video-server scan --check-rtsp

# Экспорт результатов
./local-video-server scan --export json --output results.json

# Детальный вывод
./local-video-server scan --verbose

# Использование конфигурационного файла
./local-video-server scan --config config.yaml
```

### Пример вывода:

```
Scanning network: 192.168.1.0/24
Found 5 devices:

┌──────────────┬──────────────┬──────────┬─────────────────────────────┐
│ IP Address   │ Manufacturer │ Model    │ Protocols                   │
├──────────────┼──────────────┼──────────┼─────────────────────────────┤
│ 192.168.1.10 │ Hikvision    │ DS-2CD2  │ RTSP, ONVIF, HTTP           │
│ 192.168.1.11 │ Dahua        │ IPC-HFW  │ RTSP, ONVIF                 │
│ 192.168.1.12 │ TP-Link      │ Tapo C200│ RTSP, HTTP, MJPEG           │
└──────────────┴──────────────┴──────────┴─────────────────────────────┘

RTSP Streams:
  [192.168.1.10] rtsp://192.168.1.10:554/Streaming/Channels/101
    Codec: H.264
    Resolution: 1920x1080
    FPS: 25
    Audio: AAC, 2 channels
    Status: ✓ Available
```

---

## 8. Критерии успеха

- ✅ Обнаружение всех камер в локальной сети
- ✅ Определение всех поддерживаемых протоколов
- ✅ Получение параметров RTSP потоков
- ✅ Работа на Windows, Linux, macOS
- ✅ Поддержка архитектур: x86_64, ARM64
- ✅ Быстрое сканирование (до 5 минут для сети /24)
- ✅ Стабильная работа без падений
- ✅ Понятный вывод результатов

---

## 9. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Медленное сканирование больших сетей | Высокая | Среднее | Параллельное сканирование, настраиваемые таймауты |
| Камеры с нестандартными протоколами | Средняя | Низкое | Расширяемая архитектура, плагины |
| Проблемы с firewall | Средняя | Среднее | Документация по настройке firewall |
| Отсутствие FFmpeg на системе | Низкая | Высокое | Проверка наличия, инструкции по установке |
| Проблемы с кодировками | Низкая | Низкое | UTF-8 везде, правильная обработка |

---

## 10. Дальнейшее развитие

### Возможные улучшения:
1. **Веб-интерфейс** - визуализация обнаруженных камер
2. **REST API** - для интеграции с другими системами
3. **База данных** - хранение истории сканирований
4. **Уведомления** - оповещения о новых устройствах
5. **Автоматическое сканирование** - по расписанию
6. **Мониторинг потоков** - проверка доступности в реальном времени
7. **Экспорт в системы видеонаблюдения** - интеграция с VMS

---

## 11. Временные оценки

| Этап | Время | Приоритет |
|------|-------|-----------|
| Базовая инфраструктура | 1 неделя | Высокий |
| Сканирование сети | 1 неделя | Высокий |
| Определение протоколов | 1 неделя | Высокий |
| RTSP проверка | 1 неделя | Высокий |
| Хранение и экспорт | 1 неделя | Средний |
| Оптимизация | 1 неделя | Средний |

**Общее время:** 6 недель для MVP (Minimum Viable Product)

---

## 12. Следующие шаги

1. ✅ Создать структуру проекта
2. ✅ Инициализировать Go модуль
3. ✅ Настроить базовую конфигурацию
4. ✅ Реализовать получение сетевых интерфейсов
5. ✅ Начать с простого сканирования портов


=======
# План разработки Local-video-server

## 1. Выбор технологического стека

### Основной язык: **Go (Golang)**

**Обоснование выбора:**
- ✅ **Быстродействие:** Компилируемый язык с производительностью близкой к C/C++
- ✅ **Универсальность:** Компилируется в один бинарный файл для любой ОС и архитектуры (Windows, Linux, macOS, ARM, x86_64)
- ✅ **Сетевые возможности:** Отличная стандартная библиотека для работы с сетью
- ✅ **Конкурентность:** Goroutines для параллельного сканирования сети
- ✅ **Низкое потребление памяти:** Эффективное управление ресурсами
- ✅ **Простота развертывания:** Один исполняемый файл без зависимостей

### Дополнительные инструменты:
- **FFmpeg** (CLI) - для проверки RTSP потоков и получения параметров
- **ONVIF библиотеки** - для обнаружения ONVIF устройств
- **gopacket** - для сетевого сканирования и анализа пакетов
- **Fyne** - кроссплатформенный GUI фреймворк для создания графического интерфейса в стиле Windows 10/11

---

## 2. Архитектура приложения

```
┌─────────────────────────────────────────────────────────┐
│                    Local-video-server                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Графический интерфейс (GUI)              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐       │  │
│  │  │ Scanner  │  │ Devices  │  │ Settings │       │  │
│  │  │  Panel   │  │  Panel   │  │  Panel   │       │  │
│  │  └──────────┘  └──────────┘  └──────────┘       │  │
│  └───────────────────┬──────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────▼──────────────────────────────┐  │
│  │         CLI Interface (опционально)              │  │
│  └───────────────────┬──────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────▼──────────────────────────────┐  │
│  │         Application Core                          │  │
│  │  ┌──────────────┐    ┌──────────────┐            │  │
│  │  │   Network    │    │   Protocol   │            │  │
│  │  │   Scanner    │───▶│  Detector    │            │  │
│  │  └──────────────┘    └──────────────┘            │  │
│  │         │                   │                     │  │
│  │         ▼                   ▼                     │  │
│  │  ┌──────────┐    ┌──────────────────┐            │  │
│  │  │   RTSP   │    │ Device Discovery │            │  │
│  │  │ Checker  │───▶│    & Registry    │            │  │
│  │  └──────────┘    └──────────────────┘            │  │
│  │         │                   │                     │  │
│  │         └───────────┬────────┘                     │  │
│  │                     ▼                              │  │
│  │         ┌──────────────────────┐                   │  │
│  │         │ Results Storage &    │                   │  │
│  │         │ Export               │                   │  │
│  │         └──────────────────────┘                   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### Компоненты системы:

1. **Graphical User Interface (GUI)** - Графический интерфейс в стиле Windows 10/11
   - Панель сканирования
   - Панель списка устройств
   - Панель детальной информации
   - Панель настроек
2. **CLI Interface** - Командная строка (опционально, для автоматизации)
3. **Network Scanner** - Сканирование локальной сети
4. **Protocol Detector** - Определение протоколов на устройствах
5. **RTSP Checker** - Проверка RTSP каналов и получение параметров
6. **Device Registry** - Хранение информации об обнаруженных устройствах
7. **Results Export** - Экспорт результатов в различные форматы

---

## 3. Структура проекта

```
Local-video-server/
├── cmd/
│   └── server/
│       └── main.go                 # Точка входа приложения
├── internal/
│   ├── scanner/
│   │   ├── network.go            # Сканирование сети (ARP, порты)
│   │   ├── onvif.go              # ONVIF Discovery
│   │   ├── upnp.go               # UPnP/SSDP Discovery
│   │   └── detector.go           # Определение протоколов
│   ├── rtsp/
│   │   ├── checker.go            # Проверка RTSP каналов
│   │   ├── parser.go             # Парсинг RTSP ответов
│   │   └── ffmpeg.go             # Интеграция с FFmpeg
│   ├── protocols/
│   │   ├── rtsp.go               # RTSP клиент
│   │   ├── rtmp.go               # RTMP детектор
│   │   ├── hls.go                # HLS детектор
│   │   ├── webrtc.go             # WebRTC детектор
│   │   ├── mjpeg.go              # MJPEG детектор
│   │   └── dash.go               # MPEG-DASH детектор
│   ├── models/
│   │   ├── device.go             # Модель устройства
│   │   ├── stream.go             # Модель потока
│   │   └── config.go             # Конфигурация
│   ├── storage/
│   │   └── registry.go           # Хранение результатов
│   ├── export/
│   │   ├── json.go               # Экспорт в JSON
│   │   ├── csv.go                # Экспорт в CSV
│   │   └── xml.go                # Экспорт в XML
│   └── gui/
│       ├── app.go                 # Главное окно приложения
│       ├── scanner.go             # UI компонент сканирования
│       ├── devices.go             # UI компонент списка устройств
│       ├── details.go             # UI компонент детальной информации
│       ├── settings.go            # UI компонент настроек
│       └── theme.go               # Тема оформления Windows 10/11
├── pkg/
│   └── utils/
│       ├── network.go             # Утилиты для работы с сетью
│       └── logger.go             # Логирование
├── configs/
│   └── config.yaml               # Конфигурационный файл
├── go.mod                        # Go модули
├── go.sum                        # Зависимости
├── Makefile                      # Сборка и задачи
├── README.md                     # Документация
└── DEVELOPMENT_PLAN.md           # Этот файл
```

---

## 4. Этапы разработки

### Этап 1: Базовая инфраструктура (Неделя 1)

#### 1.1. Инициализация проекта
- [ ] Создать Go модуль
- [ ] Настроить структуру проекта
- [ ] Добавить конфигурационную систему
- [ ] Настроить логирование
- [ ] Создать модели данных (Device, Stream, Config)

#### 1.2. Базовые утилиты
- [ ] Утилиты для работы с сетью (получение IP, маски подсети)
- [ ] Парсинг сетевых адресов

**Результат:** Рабочий каркас приложения с конфигурацией и логированием

---

### Этап 2: Сканирование сети (Неделя 2)

#### 2.1. Базовое сканирование сети
- [ ] Получение списка активных хостов через ARP
- [ ] Сканирование портов (554 RTSP, 1935 RTMP, 80/8080 HTTP)
- [ ] Параллельное сканирование с использованием goroutines
- [ ] Обработка таймаутов и ошибок

#### 2.2. ONVIF Discovery
- [ ] Реализация WS-Discovery протокола
- [ ] Отправка Probe сообщений
- [ ] Обработка ProbeMatch ответов
- [ ] Получение информации об устройствах через ONVIF API

#### 2.3. UPnP/SSDP Discovery
- [ ] Реализация SSDP протокола
- [ ] Отправка M-SEARCH запросов
- [ ] Обработка ответов от устройств
- [ ] Парсинг информации об устройствах

**Результат:** Обнаружение устройств в локальной сети различными методами

---

### Этап 3: Определение протоколов (Неделя 3)

#### 3.1. RTSP детектор
- [ ] Подключение к RTSP порту (554)
- [ ] Отправка OPTIONS/DESCRIBE запросов
- [ ] Парсинг ответов SDP
- [ ] Определение доступных потоков

#### 3.2. RTMP детектор
- [ ] Подключение к RTMP порту (1935)
- [ ] Отправка handshake запросов
- [ ] Определение доступности потока

#### 3.3. HTTP протоколы (HLS, MJPEG, MPEG-DASH)
- [ ] HTTP запросы к веб-интерфейсам камер
- [ ] Поиск HLS манифестов (.m3u8)
- [ ] Определение MJPEG потоков
- [ ] Поиск DASH манифестов (.mpd)

#### 3.4. WebRTC детектор
- [ ] Поиск WebRTC endpoints
- [ ] Проверка STUN/TURN серверов
- [ ] Определение WebRTC потоков

**Результат:** Определение всех поддерживаемых протоколов на каждом устройстве

---

### Этап 4: RTSP проверка и параметры (Неделя 4)

#### 4.1. RTSP клиент
- [ ] Реализация базового RTSP клиента
- [ ] Поддержка методов: OPTIONS, DESCRIBE, SETUP, PLAY
- [ ] Обработка аутентификации (Basic, Digest)
- [ ] Парсинг SDP (Session Description Protocol)

#### 4.2. Получение параметров потока
- [ ] Извлечение информации из SDP:
  - Видео кодеки (H.264, H.265, MJPEG)
  - Аудио кодеки (AAC, PCM, G.711)
  - Разрешение (width, height)
  - FPS (кадров в секунду)
  - Битрейт
  - Профили кодирования
- [ ] Получение информации о каналах (для многоканальных камер)

#### 4.3. Интеграция с FFmpeg
- [ ] Вызов FFmpeg для проверки доступности потока
- [ ] Получение детальной информации через `ffprobe`
- [ ] Парсинг вывода FFmpeg
- [ ] Fallback на FFmpeg если RTSP клиент не справляется

#### 4.4. Тестирование потоков
- [ ] Попытка подключения к потоку
- [ ] Проверка получения данных
- [ ] Определение работоспособности канала

**Результат:** Полная информация о RTSP каналах с параметрами настроек

---

### Этап 5: Хранение и экспорт (Неделя 5)

#### 5.1. Реестр устройств
- [ ] Структура для хранения обнаруженных устройств
- [ ] Кэширование результатов сканирования
- [ ] Обновление информации об устройствах
- [ ] Управление состоянием устройств

#### 5.2. Экспорт результатов
- [ ] Экспорт в JSON (структурированный формат)
- [ ] Экспорт в CSV (для таблиц)
- [ ] Экспорт в XML (для интеграций)
- [ ] Экспорт в YAML (читаемый формат)

#### 5.3. Форматирование вывода
- [ ] Красивый вывод в консоль
- [ ] Цветной вывод для терминала
- [ ] Табличное представление результатов
- [ ] Детальный вывод по запросу

**Результат:** Сохранение и экспорт результатов в различных форматах

---

### Этап 6: Графический интерфейс (GUI) (Неделя 6)

**Обязательное требование:** Графический интерфейс является обязательным компонентом приложения и должен предоставлять все функции CLI через удобный визуальный интерфейс.

#### 6.1. Выбор GUI фреймворка
- [x] Выбрать Fyne для кроссплатформенного GUI
- [ ] Настроить тему оформления в стиле Windows 10/11
- [ ] Создать базовую структуру GUI приложения
- [ ] Реализовать главное окно приложения

**Выбранный фреймворк:** [Fyne](https://fyne.io/)

**Обоснование:**
- ✅ Кроссплатформенность (Windows, Linux, macOS)
- ✅ Современный дизайн, похожий на Material Design
- ✅ Возможность кастомизации под Windows 10/11 стиль
- ✅ Простота использования и хорошая документация
- ✅ Нативная производительность
- ✅ Поддержка темной и светлой темы
- ✅ Активное сообщество и развитие

#### 6.2. Основные компоненты интерфейса
- [ ] Панель управления сканированием:
  - Поле ввода подсети
  - Кнопка "Начать сканирование"
  - Кнопка "Остановить"
  - Прогресс-бар с процентами
  - Статистика (найдено устройств, обработано, ошибок)
  - Настройки сканирования (порты, методы обнаружения)
  - Индикатор статуса
- [ ] Панель списка устройств:
  - Таблица с колонками: IP, Производитель, Модель, Протоколы, Статус
  - Фильтры и поиск
  - Сортировка по различным параметрам
  - Двойной клик для просмотра деталей
  - Иконки статуса (✓ доступно, ✗ недоступно, ⚠ предупреждение)
- [ ] Панель детальной информации:
  - Карточка устройства с основной информацией (IP, MAC, производитель, модель)
  - Вкладки: Общая информация, Протоколы, RTSP потоки
  - Список поддерживаемых протоколов
  - Детали RTSP потоков
  - Параметры потоков (кодеки, разрешение, FPS)
  - Кнопки действий: Экспорт, Копировать URL, Тест потока
- [ ] Панель настроек:
  - Вкладки: Сеть, Сканирование, Экспорт, Интерфейс
  - Настройки сети
  - Настройки сканирования
  - Настройки экспорта
  - Выбор темы оформления
  - Сохранение настроек
  - Сброс к значениям по умолчанию

#### 6.3. Дизайн в стиле Windows 10/11 (Fluent Design System)

**Цветовая схема:**
- **Светлая тема (по умолчанию):**
  - Фон: #FFFFFF (белый)
  - Фон панелей: #F3F3F3 (светло-серый)
  - Текст: #000000 (черный)
  - Акцент: #0078D4 (синий Windows)
  - Границы: #E1E1E1 (светло-серая)
- **Темная тема (опционально):**
  - Фон: #202020 (темно-серый)
  - Фон панелей: #2D2D2D (темно-серый)
  - Текст: #FFFFFF (белый)
  - Акцент: #0078D4 (синий Windows)
  - Границы: #404040 (серая)

**Типографика:**
- Основной шрифт: Segoe UI (системный шрифт Windows)
- Размеры:
  - Заголовки: 20-24px
  - Подзаголовки: 16-18px
  - Основной текст: 12-14px
  - Мелкий текст: 10-11px
- Иерархия заголовков

**Компоненты интерфейса:**
- [ ] Главное окно:
  - Заголовок с названием приложения
  - Меню (Файл, Сканирование, Настройки, Справка)
  - Панель инструментов с основными действиями
  - Область контента с вкладками
- [ ] Кнопки в стиле Windows 10/11
- [ ] Поля ввода с закругленными углами
- [ ] Карточки для устройств
- [ ] Иконки в стиле Fluent Icons
- [ ] Прозрачность и размытие (Acrylic эффект)

**Адаптивность:**
- [ ] Минимальный размер окна: 1024x768
- [ ] Оптимальный размер: 1280x720
- [ ] Поддержка изменения размера окна
- [ ] Адаптивная компоновка элементов

**Анимации и переходы:**
- [ ] Плавное появление элементов
- [ ] Анимация прогресс-бара
- [ ] Плавные переходы между вкладками
- [ ] Эффекты наведения на кнопки

#### 6.4. Функциональность GUI

**Основные функции:**
- [ ] Сканирование сети:
  - Выбор подсети для сканирования
  - Настройка параметров сканирования
  - Запуск/остановка сканирования
  - Отображение прогресса в реальном времени
  - Уведомления о найденных устройствах
- [ ] Просмотр результатов:
  - Список всех обнаруженных устройств
  - Фильтрация и поиск
  - Сортировка по различным параметрам
  - Детальная информация об устройстве
- [ ] Экспорт результатов:
  - Экспорт в JSON, CSV, XML, YAML
  - Выбор файла для сохранения
  - Уведомление об успешном экспорте
- [ ] Настройки:
  - Настройка параметров сети
  - Настройка сканирования
  - Выбор темы оформления
  - Настройки экспорта

#### 6.5. Интеграция с backend
- [ ] Связь GUI с логикой сканирования
- [ ] Обновление UI в реальном времени во время сканирования
- [ ] Обработка событий (найденные устройства, ошибки)
- [ ] Экспорт результатов через GUI
- [ ] Сохранение настроек через GUI

#### 6.6. Структура GUI кода
```
internal/gui/
├── app.go              # Главное приложение и окно
├── scanner.go          # Компонент сканирования
├── devices.go          # Компонент списка устройств
├── details.go          # Компонент детальной информации
├── settings.go         # Компонент настроек
├── theme.go            # Тема оформления Windows 10/11
└── widgets/
    ├── device_card.go  # Виджет карточки устройства
    ├── progress.go     # Виджет прогресс-бара
    └── status_icon.go  # Виджет иконки статуса
```

**Результат:** Полнофункциональный графический интерфейс в стиле Windows 10/11

---

### Этап 7: Оптимизация и доработка (Неделя 7)

#### 7.1. Производительность
- [ ] Оптимизация параллельного сканирования
- [ ] Настройка таймаутов
- [ ] Управление пулом соединений
- [ ] Кэширование DNS запросов
- [ ] Оптимизация обновлений GUI

#### 7.2. Обработка ошибок
- [ ] Graceful handling ошибок сети
- [ ] Retry механизм для неудачных запросов
- [ ] Логирование ошибок
- [ ] Продолжение работы при ошибках отдельных устройств
- [ ] Отображение ошибок в GUI

#### 7.3. Конфигурация
- [ ] Настройка диапазонов сканирования
- [ ] Настройка таймаутов
- [ ] Настройка портов для сканирования
- [ ] Настройка методов обнаружения
- [ ] Валидация конфигурационных параметров
- [ ] Оптимизация загрузки и сохранения настроек

#### 7.4. Документация
- [ ] README с примерами использования
- [ ] Документация GUI
- [ ] Примеры конфигураций
- [ ] Troubleshooting guide
- [ ] Скриншоты интерфейса

**Результат:** Оптимизированное и стабильное приложение с графическим интерфейсом

---

## 5. Технические детали реализации

### 5.1. Сканирование сети

```go
// Псевдокод основной логики
func ScanNetwork(subnet string) []Device {
    devices := []Device{}
    
    // 1. Получить список активных хостов
    hosts := getActiveHosts(subnet)
    
    // 2. Параллельное сканирование
    var wg sync.WaitGroup
    results := make(chan Device, len(hosts))
    
    for _, host := range hosts {
        wg.Add(1)
        go func(ip string) {
            defer wg.Done()
            device := scanDevice(ip)
            if device != nil {
                results <- *device
            }
        }(host)
    }
    
    go func() {
        wg.Wait()
        close(results)
    }()
    
    for device := range results {
        devices = append(devices, device)
    }
    
    return devices
}
```

### 5.2. RTSP проверка

```go
// Псевдокод RTSP проверки
func CheckRTSPStream(url string) (*StreamInfo, error) {
    // 1. Подключение к RTSP серверу
    conn, err := net.Dial("tcp", extractHost(url))
    if err != nil {
        return nil, err
    }
    defer conn.Close()
    
    // 2. Отправка OPTIONS
    optionsReq := buildRTSPRequest("OPTIONS", url)
    conn.Write(optionsReq)
    
    // 3. Отправка DESCRIBE
    describeReq := buildRTSPRequest("DESCRIBE", url)
    conn.Write(describeReq)
    
    // 4. Парсинг SDP ответа
    response := readResponse(conn)
    sdp := parseSDP(response)
    
    // 5. Извлечение параметров
    streamInfo := extractStreamInfo(sdp)
    
    return streamInfo, nil
}
```

### 5.3. Модели данных

```go
// Device - обнаруженное устройство
type Device struct {
    IP          string            `json:"ip"`
    MAC         string            `json:"mac,omitempty"`
    Hostname    string            `json:"hostname,omitempty"`
    Manufacturer string           `json:"manufacturer,omitempty"`
    Model       string            `json:"model,omitempty"`
    Protocols   []Protocol        `json:"protocols"`
    RTSPStreams []RTSPStreamInfo  `json:"rtsp_streams,omitempty"`
    DiscoveredAt time.Time        `json:"discovered_at"`
}

// Protocol - поддерживаемый протокол
type Protocol struct {
    Type        string   `json:"type"` // RTSP, RTMP, HLS, etc.
    Port        int      `json:"port"`
    URL         string   `json:"url,omitempty"`
    Available   bool     `json:"available"`
}

// RTSPStreamInfo - информация о RTSP потоке
type RTSPStreamInfo struct {
    URL         string   `json:"url"`
    Codec       string   `json:"codec"`       // H.264, H.265, MJPEG
    Resolution  string   `json:"resolution"`  // 1920x1080
    FPS         float64  `json:"fps"`
    Bitrate     int      `json:"bitrate,omitempty"`
    AudioCodec  string   `json:"audio_codec,omitempty"`
    Channels    int      `json:"channels,omitempty"`
    Available   bool     `json:"available"`
}
```

---

## 6. Зависимости (go.mod)

```go
module github.com/yourusername/local-video-server

go 1.21

require (
    // ONVIF
    github.com/use-go/onvif v0.0.0-20231025082739-ff6e66b2e8f5
    
    // Сетевое сканирование
    github.com/google/gopacket v1.1.19
    
    // HTTP клиент
    github.com/go-resty/resty/v2 v2.11.0
    
    // Конфигурация
    gopkg.in/yaml.v3 v3.0.1
    
    // Логирование
    github.com/sirupsen/logrus v1.9.3
    
    // Утилиты
    github.com/spf13/cobra v1.8.0  // CLI
    github.com/spf13/viper v1.18.2 // Конфигурация
    
    // GUI
    fyne.io/fyne/v2 v2.4.5         // Графический интерфейс
)
```

---

## 7. Пример использования

### Графический интерфейс (GUI):

**Запуск GUI приложения:**
```bash
# Запуск графического интерфейса (по умолчанию)
./local-video-server

# Или явно указать GUI режим
./local-video-server gui
```

**Возможности GUI:**
- Визуальный интерфейс в стиле Windows 10/11
- Настройка параметров сканирования через UI
- Отображение результатов в таблице
- Детальная информация об устройствах
- Экспорт результатов через диалог сохранения файла
- Настройки приложения через UI

### Командная строка (CLI):

```bash
# Сканирование всей локальной сети
./local-video-server scan

# Сканирование конкретной подсети
./local-video-server scan --subnet 192.168.1.0/24

# Сканирование с проверкой RTSP
./local-video-server scan --check-rtsp

# Экспорт результатов
./local-video-server scan --export json --output results.json

# Детальный вывод
./local-video-server scan --verbose

# Использование конфигурационного файла
./local-video-server scan --config config.yaml
```

### Пример вывода:

```
Scanning network: 192.168.1.0/24
Found 5 devices:

┌──────────────┬──────────────┬──────────┬─────────────────────────────┐
│ IP Address   │ Manufacturer │ Model    │ Protocols                   │
├──────────────┼──────────────┼──────────┼─────────────────────────────┤
│ 192.168.1.10 │ Hikvision    │ DS-2CD2  │ RTSP, ONVIF, HTTP           │
│ 192.168.1.11 │ Dahua        │ IPC-HFW  │ RTSP, ONVIF                 │
│ 192.168.1.12 │ TP-Link      │ Tapo C200│ RTSP, HTTP, MJPEG           │
└──────────────┴──────────────┴──────────┴─────────────────────────────┘

RTSP Streams:
  [192.168.1.10] rtsp://192.168.1.10:554/Streaming/Channels/101
    Codec: H.264
    Resolution: 1920x1080
    FPS: 25
    Audio: AAC, 2 channels
    Status: ✓ Available
```

---

## 8. Критерии успеха

- ✅ Обнаружение всех камер в локальной сети
- ✅ Определение всех поддерживаемых протоколов
- ✅ Получение параметров RTSP потоков
- ✅ Работа на Windows, Linux, macOS
- ✅ Поддержка архитектур: x86_64, ARM64
- ✅ Быстрое сканирование (до 5 минут для сети /24)
- ✅ Стабильная работа без падений
- ✅ Понятный вывод результатов
- ✅ **Графический интерфейс в стиле Windows 10/11**
- ✅ **Все функции доступны через GUI**
- ✅ **Интуитивно понятный интерфейс для пользователей без технических знаний**

---

## 9. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Медленное сканирование больших сетей | Высокая | Среднее | Параллельное сканирование, настраиваемые таймауты |
| Камеры с нестандартными протоколами | Средняя | Низкое | Расширяемая архитектура, плагины |
| Проблемы с firewall | Средняя | Среднее | Документация по настройке firewall |
| Отсутствие FFmpeg на системе | Низкая | Высокое | Проверка наличия, инструкции по установке |
| Проблемы с кодировками | Низкая | Низкое | UTF-8 везде, правильная обработка |

---

## 10. Дальнейшее развитие

### Возможные улучшения:
1. **Веб-интерфейс** - дополнительный веб-интерфейс для удаленного доступа
2. **REST API** - для интеграции с другими системами
3. **База данных** - хранение истории сканирований
4. **Уведомления** - оповещения о новых устройствах
5. **Автоматическое сканирование** - по расписанию
6. **Мониторинг потоков** - проверка доступности в реальном времени
7. **Экспорт в системы видеонаблюдения** - интеграция с VMS
8. **Предпросмотр потоков** - встроенный видеоплеер в GUI

---

## 11. Временные оценки

| Этап | Время | Приоритет |
|------|-------|-----------|
| Базовая инфраструктура | 1 неделя | Высокий |
| Сканирование сети | 1 неделя | Высокий |
| Определение протоколов | 1 неделя | Высокий |
| RTSP проверка | 1 неделя | Высокий |
| Хранение и экспорт | 1 неделя | Средний |
| Графический интерфейс (GUI) | 1 неделя | Высокий |
| Оптимизация | 1 неделя | Средний |

**Общее время:** 7 недель для MVP (Minimum Viable Product) с графическим интерфейсом

---

## 12. Следующие шаги

1. ✅ Создать структуру проекта
2. ✅ Инициализировать Go модуль
3. ✅ Настроить базовую конфигурацию
4. ✅ Реализовать получение сетевых интерфейсов
5. ✅ Начать с простого сканирования портов
6. 📋 Добавить Fyne в зависимости
7. 📋 Создать базовую структуру GUI
8. 📋 Реализовать главное окно приложения


>>>>>>> 7e3ee65 (ю)
